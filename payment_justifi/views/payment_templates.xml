<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- JustiFi Inline Form Template (standalone, referenced via inline_form_view_id) -->
    <template id="inline_form" name="JustiFi Inline Form">
        <!-- Get inline form values from provider (returns dict) -->
        <t t-set="jf_values"
           t-value="provider_sudo._justifi_get_inline_form_values(
                        amount,
                        currency,
                        partner_id,
                        mode == 'validation',
                    )"
        />

        <!-- Load JustiFi web components -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@justifi/webcomponents@6.7.3/dist/webcomponents/webcomponents.esm.js"/>

        <div id="justifi-payment-container"
             t-att-data-checkout-id="jf_values.get('checkout_id', '')"
             t-att-data-api-url="jf_values.get('api_url', '/payment/justifi/complete')"
             t-att-data-amount="amount"
             t-att-data-currency-id="currency.id"
             t-att-data-partner-id="partner_id"
             t-att-data-provider-id="provider_sudo.id">

            <!-- Loading state (shown briefly while component initializes) -->
            <div id="justifi-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading payment form...</p>
            </div>

            <!-- Error display -->
            <div id="justifi-error" class="alert alert-danger" style="display: none;" role="alert">
            </div>

            <!-- Static JustiFi component structure - attributes set directly from template values -->
            <justifi-tokenize-payment-method
                t-att-auth-token="jf_values.get('auth_token', '')"
                t-att-account-id="jf_values.get('account_id', '')"
                disable-bank-account="true"
                hide-submit-button="true"
                style="display: none;"
                id="justifi-tokenize">
            </justifi-tokenize-payment-method>

            <!-- Submit button -->
            <div id="justifi-submit-container" style="display: none;" class="mt-3">
                <button type="button" id="justifi-submit-btn" class="btn btn-primary w-100">
                    Pay Now
                </button>
            </div>
        </div>

        <!-- Inline script to handle events and submission -->
        <script type="text/javascript">
            (function() {
                const container = document.getElementById('justifi-payment-container');
                if (!container) return;

                // Hide Odoo's default submit button
                setTimeout(function() {
                    const submitBtns = document.querySelectorAll('.o_payment_submit_button, button[name="o_payment_submit_button"]');
                    submitBtns.forEach(function(btn) { btn.style.display = 'none'; });
                }, 100);

                const checkoutId = container.dataset.checkoutId || '';
                const apiUrl = container.dataset.apiUrl || '/payment/justifi/complete';
                const paymentAmount = container.dataset.amount || '';
                const currencyId = container.dataset.currencyId || '';
                const partnerId = container.dataset.partnerId || '';
                const providerId = container.dataset.providerId || '';

                const loadingEl = document.getElementById('justifi-loading');
                const errorEl = document.getElementById('justifi-error');
                const tokenizeEl = document.getElementById('justifi-tokenize');
                const submitContainerEl = document.getElementById('justifi-submit-container');
                const submitBtnEl = document.getElementById('justifi-submit-btn');

                function showError(message) {
                    loadingEl.style.display = 'none';
                    if (tokenizeEl) tokenizeEl.style.display = 'none';
                    submitContainerEl.style.display = 'none';
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }

                function redirectToComplete(paymentToken) {
                    console.log('=== JUSTIFI TOKEN EXTRACTION ===');
                    console.log('Raw event.detail:', paymentToken);

                    // JustiFi tokenize-payment-method returns: {response: {token: "pm_xxx", ...}}
                    // Extract the token - check response wrapper first
                    let tokenId = '';

                    if (paymentToken) {
                        // Check if wrapped in response object (this is the actual format)
                        const data = paymentToken.response || paymentToken;
                        console.log('Data to search:', data);

                        // Get token from the data object
                        if (data.token) {
                            tokenId = data.token;
                            console.log('Found token:', tokenId);
                        } else if (data.id) {
                            tokenId = data.id;
                            console.log('Found id:', tokenId);
                        }
                    }

                    // Validate it looks like a payment method token
                    if (tokenId &amp;&amp; !tokenId.toString().startsWith('pm_')) {
                        console.warn('Token does not start with pm_:', tokenId);
                    }

                    console.log('Final token ID:', tokenId);

                    if (!tokenId) {
                        console.error('NO TOKEN FOUND');
                        alert('Payment tokenization failed. Please try again.');
                        return;
                    }

                    const fields = {
                        'payment_token': tokenId,
                        'checkout_id': checkoutId,
                        'amount': paymentAmount,
                        'currency_id': currencyId,
                        'partner_id': partnerId,
                        'provider_id': providerId
                    };
                    console.log('Submitting:', fields);

                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = apiUrl;
                    for (const [key, value] of Object.entries(fields)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value || '';
                        form.appendChild(input);
                    }
                    document.body.appendChild(form);
                    form.submit();
                }

                if (!checkoutId || !tokenizeEl) {
                    showError('Payment configuration error. Please contact support.');
                    return;
                }

                // Listen for submit-event (successful tokenization)
                tokenizeEl.addEventListener('submit-event', function(event) {
                    console.log('JustiFi tokenize submit-event:', event.detail);
                    // Tokenization successful, redirect with token
                    redirectToComplete(event.detail);
                });

                // Listen for error-event
                tokenizeEl.addEventListener('error-event', function(event) {
                    console.log('JustiFi tokenize error-event:', event.detail);
                    const errorMsg = event.detail?.message || event.detail?.error || 'Payment failed. Please try again.';
                    showError(errorMsg);
                    submitBtnEl.disabled = false;
                    submitBtnEl.textContent = 'Pay Now';
                });

                // Wait for component to be defined, then show it
                customElements.whenDefined('justifi-tokenize-payment-method').then(function() {
                    console.log('justifi-tokenize-payment-method is available');
                    loadingEl.style.display = 'none';
                    tokenizeEl.style.display = 'block';
                    submitContainerEl.style.display = 'block';
                }).catch(function(err) {
                    console.error('Failed to load justifi-tokenize-payment-method:', err);
                    showError('Failed to load payment form. Please refresh the page.');
                });

                // Handle submit button click
                submitBtnEl.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    submitBtnEl.disabled = true;
                    submitBtnEl.textContent = 'Processing...';
                    console.log('Calling tokenizePaymentMethod()');
                    if (tokenizeEl &amp;&amp; typeof tokenizeEl.tokenizePaymentMethod === 'function') {
                        tokenizeEl.tokenizePaymentMethod();
                    } else {
                        console.error('tokenizePaymentMethod not available');
                        showError('Payment form not ready. Please refresh and try again.');
                    }
                });
            })();
        </script>
    </template>

</odoo>
