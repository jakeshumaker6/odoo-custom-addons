<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- JustiFi Inline Form Template (standalone, referenced via inline_form_view_id) -->
    <template id="inline_form" name="JustiFi Inline Form">
        <!-- Get inline form values from provider -->
        <t t-set="inline_form_values"
           t-value="provider_sudo._justifi_get_inline_form_values(
                        amount,
                        currency,
                        partner_id,
                        mode == 'validation',
                    )"
        />

        <!-- Load JustiFi web components directly -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@justifi/webcomponents@latest/dist/webcomponents/webcomponents.esm.js"/>

        <div id="justifi-payment-container"
             t-att-data-inline-form-values="inline_form_values">

            <!-- Loading state -->
            <div id="justifi-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading payment form...</p>
            </div>

            <!-- Error display -->
            <div id="justifi-error" class="alert alert-danger" style="display: none;" role="alert">
            </div>

            <!-- JustiFi component container -->
            <div id="justifi-component-wrapper" style="display: none;">
                <!-- justifi-modular-checkout will be inserted here by JavaScript -->
            </div>

            <!-- Our own submit button -->
            <div id="justifi-submit-container" style="display: none;" class="mt-3">
                <button type="button" id="justifi-submit-btn" class="btn btn-primary w-100">
                    Complete Payment
                </button>
            </div>
        </div>

        <!-- Inline script to initialize JustiFi component -->
        <script type="text/javascript">
            (function() {
                const container = document.getElementById('justifi-payment-container');
                if (!container) return;

                // Hide Odoo's default submit button for this provider
                // Find and hide any payment submit buttons in the parent form
                setTimeout(function() {
                    const payForm = container.closest('form');
                    if (payForm) {
                        const odooSubmitBtns = payForm.querySelectorAll('button[type="submit"], button[name="o_payment_submit_button"]');
                        odooSubmitBtns.forEach(function(btn) {
                            btn.style.display = 'none';
                        });
                    }
                    // Also try to find the payment submit button by class
                    const submitBtns = document.querySelectorAll('.o_payment_submit_button');
                    submitBtns.forEach(function(btn) {
                        btn.style.display = 'none';
                    });
                }, 100);

                // Parse inline form values from JSON
                let values = {};
                try {
                    values = JSON.parse(container.dataset.inlineFormValues || '{}');
                } catch (e) {
                    console.error('Failed to parse JustiFi inline form values:', e);
                }

                const checkoutId = values.checkout_id || '';
                const authToken = values.auth_token || '';
                const accountId = values.account_id || '';
                const paymentMethodGroupId = values.payment_method_group_id || '';
                const apiUrl = values.api_url || '/payment/justifi/complete';

                const loadingEl = document.getElementById('justifi-loading');
                const errorEl = document.getElementById('justifi-error');
                const wrapperEl = document.getElementById('justifi-component-wrapper');
                const submitContainerEl = document.getElementById('justifi-submit-container');
                const submitBtnEl = document.getElementById('justifi-submit-btn');

                function showError(message) {
                    loadingEl.style.display = 'none';
                    wrapperEl.style.display = 'none';
                    submitContainerEl.style.display = 'none';
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }

                if (!checkoutId || !authToken || !accountId) {
                    showError('Payment configuration error. Please contact support.');
                    return;
                }

                let checkoutComponent = null;

                // Wait for web components to be defined
                customElements.whenDefined('justifi-modular-checkout').then(function() {
                    loadingEl.style.display = 'none';
                    wrapperEl.style.display = 'block';
                    submitContainerEl.style.display = 'block';

                    // Create the modular checkout component
                    checkoutComponent = document.createElement('justifi-modular-checkout');
                    checkoutComponent.setAttribute('auth-token', authToken);
                    checkoutComponent.setAttribute('checkout-id', checkoutId);
                    checkoutComponent.setAttribute('account-id', accountId);
                    if (paymentMethodGroupId) {
                        checkoutComponent.setAttribute('payment-method-group-id', paymentMethodGroupId);
                    }

                    // Add card form inside modular checkout
                    const cardForm = document.createElement('justifi-card-form');
                    checkoutComponent.appendChild(cardForm);

                    // Handle successful payment
                    checkoutComponent.addEventListener('submit-event', function(event) {
                        const detail = event.detail || {};
                        console.log('JustiFi submit-event:', detail);
                        if (detail.data &amp;&amp; detail.data.id) {
                            // Payment successful, submit to Odoo
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = apiUrl;

                            const fields = {
                                'payment_id': detail.data.id,
                                'checkout_id': checkoutId
                            };

                            for (const [key, value] of Object.entries(fields)) {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = key;
                                input.value = value || '';
                                form.appendChild(input);
                            }

                            document.body.appendChild(form);
                            form.submit();
                        }
                    });

                    // Handle errors
                    checkoutComponent.addEventListener('error-event', function(event) {
                        const detail = event.detail || {};
                        console.log('JustiFi error-event:', detail);
                        showError(detail.message || 'Payment failed. Please try again.');
                        submitBtnEl.disabled = false;
                        submitBtnEl.textContent = 'Complete Payment';
                    });

                    wrapperEl.appendChild(checkoutComponent);
                }).catch(function(err) {
                    console.error('Failed to load JustiFi component:', err);
                    showError('Failed to load payment component. Please refresh the page.');
                });

                // Handle our submit button click
                submitBtnEl.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    if (checkoutComponent &amp;&amp; typeof checkoutComponent.submit === 'function') {
                        submitBtnEl.disabled = true;
                        submitBtnEl.textContent = 'Processing...';
                        checkoutComponent.submit();
                    } else {
                        console.error('JustiFi checkout component not ready');
                        showError('Payment form not ready. Please wait and try again.');
                    }
                });
            })();
        </script>
    </template>

</odoo>
