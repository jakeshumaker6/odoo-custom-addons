<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- JustiFi Inline Form Template (standalone, referenced via inline_form_view_id) -->
    <template id="inline_form" name="JustiFi Inline Form">
        <!-- Get inline form values from provider -->
        <t t-set="inline_form_values"
           t-value="provider_sudo._justifi_get_inline_form_values(
                        amount,
                        currency,
                        partner_id,
                        mode == 'validation',
                    )"
        />

        <!-- Load JustiFi web components -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@justifi/webcomponents@6.7.3/dist/webcomponents/webcomponents.esm.js"/>

        <div id="justifi-payment-container"
             t-att-data-inline-form-values="inline_form_values">

            <!-- Loading state -->
            <div id="justifi-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading payment form...</p>
            </div>

            <!-- Error display -->
            <div id="justifi-error" class="alert alert-danger" style="display: none;" role="alert">
            </div>

            <!-- JustiFi component container -->
            <div id="justifi-component-wrapper" style="display: none;">
            </div>
        </div>

        <!-- Inline script to initialize JustiFi component -->
        <script type="text/javascript">
            (function() {
                const container = document.getElementById('justifi-payment-container');
                if (!container) return;

                // Hide Odoo's default submit button
                setTimeout(function() {
                    const submitBtns = document.querySelectorAll('.o_payment_submit_button, button[name="o_payment_submit_button"]');
                    submitBtns.forEach(function(btn) { btn.style.display = 'none'; });
                }, 100);

                // Parse inline form values
                let values = {};
                try {
                    values = JSON.parse(container.dataset.inlineFormValues || '{}');
                } catch (e) {
                    console.error('Failed to parse JustiFi values:', e);
                }

                const checkoutId = values.checkout_id || '';
                const authToken = values.auth_token || '';
                const accountId = values.account_id || '';
                const apiUrl = values.api_url || '/payment/justifi/complete';

                const loadingEl = document.getElementById('justifi-loading');
                const errorEl = document.getElementById('justifi-error');
                const wrapperEl = document.getElementById('justifi-component-wrapper');

                function showError(message) {
                    loadingEl.style.display = 'none';
                    wrapperEl.style.display = 'none';
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }

                function redirectToComplete(paymentData) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = apiUrl;
                    const paymentId = paymentData?.id || paymentData?.payment_id || '';
                    const fields = { 'payment_id': paymentId, 'checkout_id': checkoutId };
                    for (const [key, value] of Object.entries(fields)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value || '';
                        form.appendChild(input);
                    }
                    document.body.appendChild(form);
                    form.submit();
                }

                if (!checkoutId || !authToken || !accountId) {
                    showError('Payment configuration error. Please contact support.');
                    return;
                }

                // Listen for submit-event on document (JustiFi fires it on document)
                document.addEventListener('submit-event', function(event) {
                    console.log('JustiFi submit-event:', event.detail);
                    // Checkout completed successfully, redirect to Odoo
                    redirectToComplete(event.detail);
                });

                // Listen for error-event on document
                document.addEventListener('error-event', function(event) {
                    console.log('JustiFi error-event:', event.detail);
                    const errorMsg = event.detail?.message || event.detail?.error || 'Payment failed. Please try again.';
                    showError(errorMsg);
                });

                // Wait for justifi-modular-checkout to be defined
                customElements.whenDefined('justifi-modular-checkout').then(function() {
                    console.log('justifi-modular-checkout is available');
                    loadingEl.style.display = 'none';
                    wrapperEl.style.display = 'block';

                    // Create the modular checkout component
                    const modularCheckout = document.createElement('justifi-modular-checkout');
                    modularCheckout.setAttribute('auth-token', authToken);
                    modularCheckout.setAttribute('checkout-id', checkoutId);

                    // Add the card form child component (required)
                    const cardForm = document.createElement('justifi-card-form');
                    modularCheckout.appendChild(cardForm);

                    // Add billing form for ZIP code (required for card payments)
                    const billingForm = document.createElement('justifi-card-billing-form-simple');
                    modularCheckout.appendChild(billingForm);

                    // Add submit button INSIDE the modular checkout component
                    const submitBtn = document.createElement('button');
                    submitBtn.id = 'justifi-submit-btn';
                    submitBtn.className = 'btn btn-primary w-100 mt-3';
                    submitBtn.type = 'button';
                    submitBtn.textContent = 'Pay Now';
                    modularCheckout.appendChild(submitBtn);

                    wrapperEl.appendChild(modularCheckout);
                    console.log('Modular checkout component added to DOM');

                    // Track if we've set the payment method
                    let paymentMethodSet = false;

                    // Listen for checkout state changes
                    modularCheckout.addEventListener('checkout-changed', function(event) {
                        console.log('JustiFi checkout-changed:', event.detail);

                        // On first checkout-changed event, set card as the payment method
                        // Per JustiFi docs: "The wrapper does not automatically select a default payment method"
                        if (!paymentMethodSet &amp;&amp; typeof modularCheckout.setSelectedPaymentMethod === 'function') {
                            console.log('Setting payment method to card');
                            modularCheckout.setSelectedPaymentMethod('card');
                            paymentMethodSet = true;
                        }

                        if (event.detail &amp;&amp; event.detail.selectedPaymentMethod) {
                            console.log('Selected payment method:', event.detail.selectedPaymentMethod);
                        }
                    });

                    // Handle submit button click - calls submitCheckout() method
                    submitBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Processing...';
                        console.log('Calling modularCheckout.submitCheckout()');
                        modularCheckout.submitCheckout();
                    });
                }).catch(function(err) {
                    console.error('Failed to load justifi-modular-checkout:', err);
                    showError('Failed to load payment form. Please refresh the page.');
                });
            })();
        </script>
    </template>

</odoo>
