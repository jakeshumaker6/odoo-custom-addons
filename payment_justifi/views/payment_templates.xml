<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- JustiFi Inline Form Template -->
    <template id="payment_form_justifi" name="JustiFi Payment Form">
        <!-- Load JustiFi web components directly -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@justifi/webcomponents@latest/dist/webcomponents/webcomponents.esm.js"/>

        <div id="justifi-payment-container"
             t-att-data-checkout-id="checkout_id"
             t-att-data-auth-token="auth_token"
             t-att-data-account-id="account_id"
             t-att-data-payment-method-group-id="payment_method_group_id"
             t-att-data-api-url="api_url"
             t-att-data-reference="reference">

            <!-- Loading state -->
            <div id="justifi-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading payment form...</p>
            </div>

            <!-- Error display -->
            <div id="justifi-error" class="alert alert-danger" style="display: none;" role="alert">
            </div>

            <!-- JustiFi component container -->
            <div id="justifi-component-wrapper" style="display: none;">
                <!-- justifi-modular-checkout will be inserted here by JavaScript -->
            </div>
        </div>
    </template>

    <!-- Extend the payment form to include JustiFi -->
    <template id="payment_provider_inline_form_justifi"
              inherit_id="payment.payment_provider_inline_form"
              primary="True">
        <xpath expr="//div[hasclass('o_payment_provider_inline_form')]" position="inside">
            <t t-if="provider_sudo.code == 'justifi'">
                <t t-call="payment_justifi.payment_form_justifi">
                    <t t-set="checkout_id" t-value="provider_sudo_values.get('checkout_id', '')"/>
                    <t t-set="auth_token" t-value="provider_sudo_values.get('auth_token', '')"/>
                    <t t-set="account_id" t-value="provider_sudo_values.get('account_id', '')"/>
                    <t t-set="payment_method_group_id" t-value="provider_sudo_values.get('payment_method_group_id', '')"/>
                    <t t-set="api_url" t-value="provider_sudo_values.get('api_url', '/payment/justifi/complete')"/>
                    <t t-set="reference" t-value="reference"/>
                </t>
            </t>
        </xpath>
    </template>

</odoo>
