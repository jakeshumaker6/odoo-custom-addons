<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- JustiFi Inline Form Template (standalone, referenced via inline_form_view_id) -->
    <template id="inline_form" name="JustiFi Inline Form">
        <!-- Get inline form values from provider (returns dict) -->
        <t t-set="jf_values"
           t-value="provider_sudo._justifi_get_inline_form_values(
                        amount,
                        currency,
                        partner_id,
                        mode == 'validation',
                    )"
        />

        <!-- Load JustiFi web components -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@justifi/webcomponents@6.7.3/dist/webcomponents/webcomponents.esm.js"/>

        <div id="justifi-payment-container"
             t-att-data-checkout-id="jf_values.get('checkout_id', '')"
             t-att-data-api-url="jf_values.get('api_url', '/payment/justifi/complete')">

            <!-- Loading state (shown briefly while component initializes) -->
            <div id="justifi-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading payment form...</p>
            </div>

            <!-- Error display -->
            <div id="justifi-error" class="alert alert-danger" style="display: none;" role="alert">
            </div>

            <!-- Static JustiFi component structure - attributes set directly from template values -->
            <justifi-tokenize-payment-method
                t-att-auth-token="jf_values.get('auth_token', '')"
                t-att-account-id="jf_values.get('account_id', '')"
                disable-bank-account="true"
                hide-submit-button="true"
                style="display: none;"
                id="justifi-tokenize">
            </justifi-tokenize-payment-method>

            <!-- Submit button -->
            <div id="justifi-submit-container" style="display: none;" class="mt-3">
                <button type="button" id="justifi-submit-btn" class="btn btn-primary w-100">
                    Pay Now
                </button>
            </div>
        </div>

        <!-- Inline script to handle events and submission -->
        <script type="text/javascript">
            (function() {
                const container = document.getElementById('justifi-payment-container');
                if (!container) return;

                // Hide Odoo's default submit button
                setTimeout(function() {
                    const submitBtns = document.querySelectorAll('.o_payment_submit_button, button[name="o_payment_submit_button"]');
                    submitBtns.forEach(function(btn) { btn.style.display = 'none'; });
                }, 100);

                const checkoutId = container.dataset.checkoutId || '';
                const apiUrl = container.dataset.apiUrl || '/payment/justifi/complete';

                const loadingEl = document.getElementById('justifi-loading');
                const errorEl = document.getElementById('justifi-error');
                const tokenizeEl = document.getElementById('justifi-tokenize');
                const submitContainerEl = document.getElementById('justifi-submit-container');
                const submitBtnEl = document.getElementById('justifi-submit-btn');

                function showError(message) {
                    loadingEl.style.display = 'none';
                    if (tokenizeEl) tokenizeEl.style.display = 'none';
                    submitContainerEl.style.display = 'none';
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }

                function redirectToComplete(paymentToken) {
                    console.log('=== JUSTIFI DEBUG ===');
                    console.log('Raw paymentToken:', paymentToken);
                    console.log('Type:', typeof paymentToken);
                    console.log('JSON:', JSON.stringify(paymentToken, null, 2));

                    // Extract token ID - try all possible locations
                    let tokenId = '';
                    if (paymentToken) {
                        // JustiFi tokenize returns {id: "pm_xxx", ...} for the payment method
                        tokenId = paymentToken.id ||
                                  paymentToken.token ||
                                  paymentToken.payment_method_id ||
                                  (paymentToken.data &amp;&amp; paymentToken.data.id) ||
                                  (paymentToken.payment_method &amp;&amp; paymentToken.payment_method.id) ||
                                  '';

                        // If still no token and it's an object, try to find any property ending with _id
                        if (!tokenId &amp;&amp; typeof paymentToken === 'object') {
                            for (const key of Object.keys(paymentToken)) {
                                const val = paymentToken[key];
                                if (typeof val === 'string' &amp;&amp; val.startsWith('pm_')) {
                                    tokenId = val;
                                    console.log('Found token in key:', key);
                                    break;
                                }
                            }
                        }
                    }

                    console.log('Extracted token ID:', tokenId);

                    if (!tokenId) {
                        console.error('NO TOKEN ID FOUND - Check the raw paymentToken above');
                        // Show alert so user can report the data structure
                        alert('Debug: No token found. Check console (F12) and report the paymentToken structure.');
                    }

                    const fields = { 'payment_token': tokenId, 'checkout_id': checkoutId };
                    console.log('Submitting to backend:', fields);

                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = apiUrl;
                    for (const [key, value] of Object.entries(fields)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value || '';
                        form.appendChild(input);
                    }
                    document.body.appendChild(form);
                    form.submit();
                }

                if (!checkoutId || !tokenizeEl) {
                    showError('Payment configuration error. Please contact support.');
                    return;
                }

                // Listen for submit-event (successful tokenization)
                tokenizeEl.addEventListener('submit-event', function(event) {
                    console.log('JustiFi tokenize submit-event:', event.detail);
                    // Tokenization successful, redirect with token
                    redirectToComplete(event.detail);
                });

                // Listen for error-event
                tokenizeEl.addEventListener('error-event', function(event) {
                    console.log('JustiFi tokenize error-event:', event.detail);
                    const errorMsg = event.detail?.message || event.detail?.error || 'Payment failed. Please try again.';
                    showError(errorMsg);
                    submitBtnEl.disabled = false;
                    submitBtnEl.textContent = 'Pay Now';
                });

                // Wait for component to be defined, then show it
                customElements.whenDefined('justifi-tokenize-payment-method').then(function() {
                    console.log('justifi-tokenize-payment-method is available');
                    loadingEl.style.display = 'none';
                    tokenizeEl.style.display = 'block';
                    submitContainerEl.style.display = 'block';
                }).catch(function(err) {
                    console.error('Failed to load justifi-tokenize-payment-method:', err);
                    showError('Failed to load payment form. Please refresh the page.');
                });

                // Handle submit button click
                submitBtnEl.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    submitBtnEl.disabled = true;
                    submitBtnEl.textContent = 'Processing...';
                    console.log('Calling tokenizePaymentMethod()');
                    if (tokenizeEl &amp;&amp; typeof tokenizeEl.tokenizePaymentMethod === 'function') {
                        tokenizeEl.tokenizePaymentMethod();
                    } else {
                        console.error('tokenizePaymentMethod not available');
                        showError('Payment form not ready. Please refresh and try again.');
                    }
                });
            })();
        </script>
    </template>

</odoo>
